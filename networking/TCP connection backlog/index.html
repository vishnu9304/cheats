



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.3.0">
    
    
      
        <title>TCP Backlogs - CHEATS</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.572ca0f0.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#ab47bc">
      
    
    
      <script src="../../assets/javascripts/modernizr.962652e9.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700|Muli">
        <style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Muli","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="purple" data-md-color-accent="purple">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#linux-tcp-backlogs" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="CHEATS" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                CHEATS
              </span>
              <span class="md-header-nav__topic">
                TCP Backlogs
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="CHEATS" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    CHEATS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="MY CHEATS" class="md-nav__link">
      MY CHEATS
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      CRYPTOGRAPHY
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        CRYPTOGRAPHY
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../crypto/network_security/" title="Network Security" class="md-nav__link">
      Network Security
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../crypto/ssl/" title="SSL" class="md-nav__link">
      SSL
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      DOCKER
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        DOCKER
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../docker/docker_ca/" title="Docker CA" class="md-nav__link">
      Docker CA
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      GOLANG
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        GOLANG
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../golang/gomod/" title="gomod" class="md-nav__link">
      gomod
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../golang/go_tools/" title="gotools" class="md-nav__link">
      gotools
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      NETWORKING
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        NETWORKING
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Linux Networking/" title="Networking" class="md-nav__link">
      Networking
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        TCP Backlogs
      </label>
    
    <a href="./" title="TCP Backlogs" class="md-nav__link md-nav__link--active">
      TCP Backlogs
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#linux-tcp-backlogs" title="Linux TCP Backlogs" class="md-nav__link">
    Linux TCP Backlogs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-points" title="Key Points" class="md-nav__link">
    Key Points
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-will-happen-if-accept-queue-is-full" title="What will happen if Accept Queue is full?" class="md-nav__link">
    What will happen if Accept Queue is full?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-is-half-open-connections" title="What is Half Open Connections?" class="md-nav__link">
    What is Half Open Connections?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#queue-size-limits" title="Queue size limits" class="md-nav__link">
    Queue size limits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting" title="Troubleshooting:" class="md-nav__link">
    Troubleshooting:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      WEB
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        WEB
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../web/http/" title="HTTP" class="md-nav__link">
      HTTP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../web/nginx/" title="Nginx" class="md-nav__link">
      Nginx
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#linux-tcp-backlogs" title="Linux TCP Backlogs" class="md-nav__link">
    Linux TCP Backlogs
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-points" title="Key Points" class="md-nav__link">
    Key Points
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-will-happen-if-accept-queue-is-full" title="What will happen if Accept Queue is full?" class="md-nav__link">
    What will happen if Accept Queue is full?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-is-half-open-connections" title="What is Half Open Connections?" class="md-nav__link">
    What is Half Open Connections?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#queue-size-limits" title="Queue size limits" class="md-nav__link">
    Queue size limits
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshooting" title="Troubleshooting:" class="md-nav__link">
    Troubleshooting:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>TCP Backlogs</h1>
                
                <h3 id="linux-tcp-backlogs">Linux TCP Backlogs</h3>
<p><strong>References:</strong></p>
<p>https://bunn.cc/2017/syn-backlog/</p>
<p>https://blog.cloudflare.com/syn-packet-handling-in-the-wild/</p>
<p>https://eklitzke.org/how-tcp-sockets-work</p>
<p><img alt="Render Graph" src="https://blog.cloudflare.com/content/images/2018/01/all-1.jpeg" /></p>
<h4 id="key-points">Key Points</h4>
<p>1 - The incoming connections get queued up, waiting for the application to accept(2) them.</p>
<p>2 - The queue that holds established connections is (of course) of finite length. </p>
<p>3 - Each bound socket, in the <strong>"LISTENING"</strong> TCP state has two separate queues.</p>
<pre><code>The SYN Queue:
The SYN Queue stores inbound SYN packets.
It's responsible for sending out SYN+ACK packets and retrying them on timeout.
On Linux the number of retries is configured with: sysctl net.ipv4.tcp_synack_retries

The Accept Queue: 
The Accept Queue contains fully established connections and ready to be picked up by the application.
</code></pre>
<h4 id="what-will-happen-if-accept-queue-is-full">What will happen if <strong>Accept Queue</strong> is full?</h4>
<p>If the TCP implementation in Linux receives the ACK packet of the 3-way handshake and the accept queue is full, it will basically ignore that packet.</p>
<pre><code>Note: There is a timer associated with the SYN RECEIVED state.
</code></pre>
<p>If the <strong>ACK</strong> packet is not received (or if it is ignored, as in the case considered here), then the TCP implementation will resend the <strong>SYN/ACK</strong> packet (with a certain number of retries specified by <strong>/proc/sys/net/ipv4/tcp_synack_retries</strong> and using an exponential backoff algorithm).</p>
<p>After retries it will sent <strong>RST</strong> packet.</p>
<h4 id="what-is-half-open-connections">What is Half Open Connections?</h4>
<p>If the client first waits for data from the server and the server never reduces the backlog, then the end result is that on the client side, the connection is in state ESTABLISHED, while on the server side, the connection is considered CLOSED.</p>
<p>This means that we end up with a half-open connection!</p>
<pre><code>Note: If the accept queue is full, then the kernel will impose a limit on the rate at which SYN packets are accepted.
</code></pre>
<p>If too many SYN packets are received, some of them will be dropped.</p>
<h4 id="queue-size-limits">Queue size limits</h4>
<p>The maximum allowed length of both the Accept and SYN Queues is taken from the backlog parameter passed to the listen(2) syscall by the application.</p>
<p>For example, this sets the Accept and SYN Queue sizes to 1,024:</p>
<pre><code>listen(sfd, 1024)
</code></pre>
<p>This SYN Queue cap used to be configured by the net.ipv4.tcp_max_syn_backlog toggle, but this isn't the case anymore.</p>
<p>Nowadays <strong>net.core.somaxconn</strong> caps both queue sizes.</p>
<h4 id="troubleshooting">Troubleshooting:</h4>
<p>To peek into the <strong>SYN Queue</strong> on Linux we can use the <strong>ss</strong> command and look for <strong>SYN-RECV</strong> sockets.</p>
<pre><code>$ ss -n state syn-recv sport = :80 | wc -l
119
$ ss -n state syn-recv sport = :443 | wc -l
78

Note: don't confuse Recv-Q and Send-Q fields with the SYN Queue and ACCEPT Queue.

SYN Queue and ACCEPT Queues are used per application.
Recv-Q and Send-Q are used per TCP connection.
</code></pre>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../Linux Networking/" title="Networking" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Networking
              </span>
            </div>
          </a>
        
        
          <a href="../../web/http/" title="HTTP" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                HTTP
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.a353778b.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>